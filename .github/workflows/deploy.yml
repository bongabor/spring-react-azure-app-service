
name: Deploy
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    # Global env for this job (used by Terraform and/or az CLI steps)
    env:
      # Terraform backend (Azure Storage) access key
      ARM_ACCESS_KEY: ${{ secrets.TFSTATE_STORAGE_KEY }}

      # Terraform AzureRM provider auth (Service Principal)
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

      # Terraform variables (auto-mapped via TF_VAR_*)
      TF_VAR_subscription_id: ${{ secrets.TF_VAR_subscription_id }}
      TF_VAR_tenant_id:       ${{ secrets.TF_VAR_tenant_id }}
      TF_VAR_name:            ${{ secrets.TF_VAR_name }}
      TF_VAR_location:        ${{ secrets.TF_VAR_location }}
      TF_VAR_env:             ${{ secrets.TF_VAR_env }}

    steps:
      # ---------- Source ----------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Tooling ----------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      # ---------- Infra: Terraform ----------
      # Uses ARM_* env vars above to authenticate provider non-interactively
      - name: Terraform Apply
        run: make terraform-apply

      # Pin Node 16 for CRA/PostCSS compatibility
      - name: Setup Node for UI build
        uses: actions/setup-node@v4
        with:
          node-version: '16.20.2'
          cache: 'yarn'
          cache-dependency-path: ui/yarn.lock

      # ---------- Build artifacts ----------
      - name: Build UI (non-prod)
        run: make ui-build-nonprod

      - name: Build Backend
        run: make backend-build

      # ---------- Deploy (authenticate once via SPN) ----------
      # This logs in to Azure using the Service Principal JSON in AZURE_SP_CREDENTIALS.
      # Required since Publish Profile is not available with Basic Auth disabled.
      - name: Azure login (Service Principal secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_JSON }}
   

      - name: Upload to $web
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            # Fail fast if the secret is missing
            if [ -z "${{ secrets.AZURE_STORAGE_ACCOUNT }}" ]; then
              echo "AZURE_STORAGE_ACCOUNT secret is not set."; exit 1
            fi

            # (Optional) ensure static website is enabled
            az storage blob service-properties update \
              --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" \
              --static-website --index-document index.html --404-document 404.html \
              --auth-mode login

            # Upload build to $web
            az storage blob upload-batch \
              --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" \
              --destination '$web' \
              --source ./ui/build \
              --auth-mode login \
              --only-show-errors

      # ---------- Deploy Backend JAR to App Service ----------
      # azure/webapps-deploy will use the SPN session from azure/login.
      - name: Deploy Backend App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.TF_VAR_name }}-bff-${{ secrets.TF_VAR_env }}
          package: backend/build/libs/*.jar